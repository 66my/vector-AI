import{v as be,_ as ye,a as xe,b as De,c as he,d as Ee,e as Ce,f as Se,g as Te,h as Ue,i as Ie,j as Ne,k as Re,l as We,m as $e,n as Oe,o as Ve,p as je,q as Pe,r as Ae,s as Be,t as Fe,u as He,w as Le,x as Me,y as qe,K as ze,z as Ze,A as Ye,B as Je,C as Ke,D as Xe}from"./style-e3c0c3b7.js";import{u as Ge,r as v,a as Qe,b as eo,c as oo,s as Z,d as to,o as so,w as Y,m as W,h as $,e as ao,f as i,g as w,i as E,j as t,k as O,l as n,n as J,v as K,p as c,L as no,q as g,t as m,F as X,x as G,M as ro,y as lo,E as co,z as Q}from"./index-6885f779.js";import{u as io}from"./userAccount-f1cc96ef.js";import{u as uo}from"./userDatabase-bdfe0305.js";import{_ as _o}from"./MarkdownEditor-4f57257e.js";import{_ as po}from"./UploaderFieldUse-37ff990e.js";import{d as fo}from"./database-07243708.js";import{_ as mo}from"./_plugin-vue_export-helper-c27b6911.js";import"./TemperatureInput-afe41978.js";const vo={key:0,class:"loading-container"},wo={key:1,class:"editor-container"},go={class:"title-container"},ko={__name:"WorkflowEditor",setup(bo){console.log("in workflow editor");const{t:s}=Ge(),V=v(!0),ee=Qe(),D=eo(),k=ee.params.workflowId,h=v(s("workspace.workflowEditor.workflow_canvas")),oe=oo([s("workspace.workflowEditor.workflow_info"),s("workspace.workflowEditor.workflow_canvas")]),te=io();Z(te);const j=uo(),{userDatabases:se}=Z(j),ae=to(),C=v(""),a=v({}),_=v([]);so(async()=>{const o=Y("get",{wid:k}),e=fo("list",{}),u=await o,p=await e;if(p.status==200&&j.setUserDatabases(p.data),u.status!=200){W.error(s("workspace.workflowSpace.get_workflow_failed")),D.push({name:"WorkflowSpaceMain"});return}a.value=u.data,a.value.data.nodes.forEach(r=>{r.category=="vectorDb"&&(r.data.template.database.options=se.value.filter(d=>d.status=="VALID").map(d=>({value:d.vid,label:d.name})))}),a.value.tags=a.value.tags.map(r=>r.tid),_.value=[...a.value.data.nodes,...a.value.data.edges],_.value.forEach(r=>{r.events={change:d=>B(),delete:d=>F(d)}}),C.value=$(a.value),V.value=!1});const S=v(!1),P=async()=>{S.value=!0,a.value.data=A(),(await Y("update",{wid:k,...a.value})).status==200?(W.success(s("workspace.workflowSpace.save_success")),C.value=$(a.value)):W.error(s("workspace.workflowSpace.save_failed")),ae.updateUserWorkflow(a.value),S.value=!1},ne=()=>{a.value.data=A(),C.value!=$(a.value)?ro.confirm({title:s("common.back"),icon:lo(co),content:s("workspace.workflowEditor.exit_not_saved_confirm"),okText:s("workspace.workflowEditor.save_and_exit"),cancelText:s("workspace.workflowEditor.exit_without_save"),onOk(){P().then(()=>{D.push({name:"WorkflowUse",params:{workflowId:k}})})},onCancel(){D.push({name:"WorkflowUse",params:{workflowId:k}})}}):D.push({name:"WorkflowUse",params:{workflowId:k}})},{addEdges:re,updateEdge:le,onConnect:ce,toObject:A}=be();ce(o=>{o.animated=!0,o.style={strokeWidth:3,stroke:"#565656"},re([o])});const ie=({edge:o,connection:e})=>{le(o,e)},B=o=>{},F=o=>{_.value=_.value.filter(e=>e.id!==o.id),_.value=_.value.filter(e=>!(e.source&&e.source===o.id||e.target&&e.target===o.id))},ue=o=>{_.value=_.value.filter(e=>!(e.source===o.edge.source&&e.target===o.edge.target&&e.sourceHandle===o.edge.sourceHandle&&e.targetHandle===o.edge.targetHandle))};let H=null;const de=o=>{H=o};let L=null;const _e=o=>{o.dataTransfer.setData("nodeType",o.target.id)},pe=o=>{const e=o.srcElement.id,u=M[e],p=Xe(),r=JSON.parse(JSON.stringify(T[e].props.templateData));r.description=s(`components.nodes.${u}.${e}.description`),Object.keys(r.template).forEach(f=>{r.template[f].display_name=s(`components.nodes.${u}.${e}.${f}`)});const d=L.getBoundingClientRect(),{x:U,y:I,zoom:y}=H.viewport.value,x=o.clientX-d.left,N=o.clientY-d.top,R={id:p,type:e,category:u,position:{x:(x-U)/y,y:(N-I)/y},data:r,events:{change:f=>B(),delete:f=>F(f)}};_.value.push(R)},fe=o=>{o.preventDefault(),L=o.target},me=Object.assign({"/src/components/nodes/controlFlows/Conditional.vue":ye,"/src/components/nodes/controlFlows/Empty.vue":xe,"/src/components/nodes/controlFlows/RandomChoice.vue":De,"/src/components/nodes/fileProcessing/FileLoader.vue":he,"/src/components/nodes/imageGeneration/StableDiffusion.vue":Ee,"/src/components/nodes/llms/OpenAI.vue":Ce,"/src/components/nodes/outputs/Document.vue":Se,"/src/components/nodes/outputs/Email.vue":Te,"/src/components/nodes/outputs/Mindmap.vue":Ue,"/src/components/nodes/outputs/Text.vue":Ie,"/src/components/nodes/textProcessing/ListRender.vue":Ne,"/src/components/nodes/textProcessing/MarkdownToHtml.vue":Re,"/src/components/nodes/textProcessing/TemplateCompose.vue":We,"/src/components/nodes/textProcessing/TextInOut.vue":$e,"/src/components/nodes/textProcessing/TextSplitters.vue":Oe,"/src/components/nodes/tools/ImageSearch.vue":Ve,"/src/components/nodes/tools/ProgrammingFunction.vue":je,"/src/components/nodes/triggers/ButtonTrigger.vue":Pe,"/src/components/nodes/vectorDb/AddData.vue":Ae,"/src/components/nodes/vectorDb/DeleteData.vue":Be,"/src/components/nodes/vectorDb/Search.vue":Fe,"/src/components/nodes/webCrawlers/BilibiliCrawler.vue":He,"/src/components/nodes/webCrawlers/TextCrawler.vue":Le,"/src/components/nodes/webCrawlers/YoutubeCrawler.vue":Me}),T={},b={},M={};return Object.entries(me).forEach(([o,e])=>{const u=o.match(/\/([^/]+)\.vue$/)[1];T[u]=ao(e.default);const p=o.match(/\/([^/]+)\/[^/]+\.vue$/)[1];b[p]||(b[p]=[]),b[p].push(u),M[u]=p}),(o,e)=>{const u=i("a-spin"),p=i("a-typography-link"),r=i("a-col"),d=i("a-typography-text"),U=i("a-segmented"),I=i("a-button"),y=i("a-row"),x=i("a-divider"),N=i("a-menu-item"),R=i("a-sub-menu"),f=i("a-menu"),ve=i("a-layout-sider"),we=i("a-layout-content"),q=i("a-layout");return V.value?(w(),E("div",vo,[t(u,{size:"large"})])):(w(),E("div",wo,[O("div",go,[t(y,{type:"flex",align:"middle",justify:"space-between",gutter:[16,16],style:{width:"100%"}},{default:n(()=>[t(r,{flex:"0 0"},{default:n(()=>[t(p,{onClick:ne,style:{"text-wrap":"nowrap"}},{default:n(()=>[t(c(no)),g(" "+m(c(s)("common.back")),1)]),_:1})]),_:1}),t(r,{flex:"0 0"},{default:n(()=>[t(d,{class:"title",editable:{triggerType:["text","icon"]},content:a.value.title,"onUpdate:content":e[0]||(e[0]=l=>a.value.title=l)},null,8,["content"])]),_:1}),t(r,{flex:"1 0",style:{display:"flex","justify-content":"center"}},{default:n(()=>[t(U,{value:h.value,"onUpdate:value":e[1]||(e[1]=l=>h.value=l),options:oe},null,8,["value","options"])]),_:1}),t(r,{flex:"0 0",style:{display:"flex","justify-content":"end"}},{default:n(()=>[t(I,{type:"primary",onClick:P,"confirm-loading":S.value},{default:n(()=>[g(m(c(s)("common.save")),1)]),_:1},8,["confirm-loading"])]),_:1})]),_:1})]),J(O("div",null,[t(y,{justify:"center"},{default:n(()=>[t(r,{lg:10,md:12,sm:18,xs:24},{default:n(()=>[t(x,null,{default:n(()=>[g(m(c(s)("workspace.workflowEditor.tags")),1)]),_:1}),t(qe,{modelValue:a.value.tags,"onUpdate:modelValue":e[2]||(e[2]=l=>a.value.tags=l)},null,8,["modelValue"]),t(x,null,{default:n(()=>[g(m(c(s)("workspace.workflowEditor.brief_info")),1)]),_:1}),t(_o,{markdown:a.value.brief,"onUpdate:markdown":e[3]||(e[3]=l=>a.value.brief=l)},null,8,["markdown"]),t(x,null,{default:n(()=>[g(m(c(s)("workspace.workflowEditor.brief_images")),1)]),_:1}),t(po,{modelValue:a.value.images,"onUpdate:modelValue":e[4]||(e[4]=l=>a.value.images=l),multiple:!0},null,8,["modelValue"])]),_:1})]),_:1})],512),[[K,h.value==c(s)("workspace.workflowEditor.workflow_info")]]),J(t(q,{"has-sider":"",style:{height:"100%"}},{default:n(()=>[t(ve,{style:{overflow:"auto",backgroundColor:"#fff"},class:"custom-scrollbar"},{default:n(()=>[t(f,{theme:"light",mode:"inline"},{default:n(()=>[(w(!0),E(X,null,G(Object.keys(b),(l,ge)=>(w(),Q(R,{key:`category-${ge}`},{title:n(()=>[g(m(c(s)(`components.nodes.${l}.title`)),1)]),default:n(()=>[(w(!0),E(X,null,G(b[l],(z,ke)=>(w(),Q(N,{id:z,draggable:"true",onDragstart:_e,onDragend:pe,key:`node-${ke}`},{default:n(()=>[O("span",null,m(c(s)(`components.nodes.${l}.${z}.title`)),1)]),_:2},1032,["id"]))),128))]),_:2},1024))),128))]),_:1})]),_:1}),t(q,null,{default:n(()=>[t(we,{style:{margin:"24px 16px 0",overflow:"initial"}},{default:n(()=>[t(c(ze),{modelValue:_.value,"onUpdate:modelValue":e[5]||(e[5]=l=>_.value=l),"default-edge-options":{type:"smoothstep"},"node-types":T,edgesUpdatable:!0,onEdgeUpdate:ie,onPaneReady:de,onDragover:fe,onEdgeDoubleClick:ue,"snap-to-grid":!0,"snap-grid":[20,20]},{default:n(()=>[t(c(Ze)),t(c(Ye)),t(c(Je),{variant:c(Ke).Dots},null,8,["variant"])]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1},512),[[K,h.value==c(s)("workspace.workflowEditor.workflow_canvas")]])]))}}},Io=mo(ko,[["__scopeId","data-v-5e83e68a"]]);export{Io as default};
